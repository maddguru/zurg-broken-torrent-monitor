# Version 2.2.1 Update Notes

## üêõ Critical Bug Fix Release

Version 2.2.1 is a critical bug fix release that resolves the PowerShell array unwrapping issue introduced in v2.2.0.

---

## üö® What's Fixed in v2.2.1

### Critical Bug: False "API Failed" Errors

**Issue:** When library had zero broken/under repair torrents (healthy state), the script showed:
```
[ERROR] Failed to retrieve torrent status - API calls failed
```

**Root Cause:** PowerShell automatically "unwraps" empty arrays to `$null` when returning from functions. The script thought the API call failed when it actually succeeded with 0 results.

**Solution:** Added comma operator (`,`) to force PowerShell to preserve empty arrays:
```powershell
# Before (broken):
return $torrents

# After (fixed):
return ,$torrents
```

---

## üîç How We Found It

Debug logging revealed:
```
‚úì Returning array with 0 torrent(s)    ‚Üê Function returns array

RESULT ANALYSIS:
  Variable is null: True                ‚Üê PowerShell receives $null!
  Variable is Array: False
```

This is a well-known PowerShell gotcha that silently converts empty arrays to `$null`.

---

## ‚úÖ What Works Now

### Before v2.2.1 (Broken):
```
[2025-11-12 23:55:15] [INFO] Starting torrent status check...
[2025-11-12 23:55:17] [ERROR] Failed to retrieve torrent status - API calls failed
```

### After v2.2.1 (Fixed):
```
[2025-11-13 00:03:13] [INFO] Starting torrent status check...
[2025-11-13 00:03:15] [INFO] Found 0 broken torrent(s)
[2025-11-13 00:03:15] [INFO] Found 0 under repair torrent(s)
[2025-11-13 00:03:15] [SUCCESS] ‚úì No broken or under repair torrents found - library is healthy!

======================================================================
  CHECK SUMMARY
======================================================================

TORRENT STATISTICS:
  Total Torrents:            5,457
  OK Torrents:               5,457 (100%)
  Broken:                    0 (0%)
  Under Repair:              0 (0%)
```

---

## üîß Technical Details

### Changes Made

**File:** `Zurg-Broken-Torrent-Monitor.ps1`
**Line:** 255

```powershell
# Line 255 - Added comma operator
return ,$torrents  # Forces array to stay as array
```

**That's it!** One character fix.

### Why This Happens

PowerShell has unusual array handling:
```powershell
function Test {
    $items = @()    # Empty array
    return $items   # Gets unwrapped to $null
}

$result = Test
$null -eq $result  # TRUE (unexpected!)
```

The comma operator prevents unwrapping:
```powershell
function TestFixed {
    $items = @()
    return ,$items  # Comma preserves array
}

$result = TestFixed
$null -eq $result    # FALSE (correct!)
$result -is [Array]  # TRUE (correct!)
```

---

## üì¶ What's Included in v2.2.1

All v2.2.0 features PLUS the critical bug fix:

‚úÖ Total torrent statistics with percentages
‚úÖ Health monitoring and context
‚úÖ **FIXED:** Proper handling of healthy libraries (0 broken)
‚úÖ **FIXED:** Array unwrapping issue resolved
‚úÖ Enhanced error detection
‚úÖ Improved logging

---

## üöÄ Upgrade Instructions

### From v2.2.0 ‚Üí v2.2.1

**This is a critical upgrade if you're on v2.2.0!**

1. Download the v2.2.1 script
2. Replace your existing file
3. No configuration changes needed
4. Restart your monitoring service

```powershell
# Stop current monitoring (Ctrl+C if running)
# Replace file
# Restart
.\Zurg-Broken-Torrent-Monitor.ps1 -CheckIntervalMinutes 30
```

### From v2.1.0 ‚Üí v2.2.1

All v2.2.0 features plus bug fixes. See [V2.2-UPDATE-NOTES.md](V2.2-UPDATE-NOTES.md) for full v2.2 features.

---

## üß™ How to Test

Run once to verify:
```powershell
.\Zurg-Broken-Torrent-Monitor.ps1 -RunOnce
```

**With healthy library (0 broken), you should see:**
- ‚úÖ SUCCESS message (not ERROR)
- ‚úÖ Statistics showing 100% OK
- ‚úÖ Check summary displayed
- ‚úÖ No false API failure errors

---

## üìä Version Comparison

| Version | Empty Array Handling | Healthy Library Detection |
|---------|---------------------|---------------------------|
| v2.2.0 | ‚ùå Broken (unwraps to null) | ‚ùå Shows ERROR |
| v2.2.1 | ‚úÖ Fixed (comma operator) | ‚úÖ Shows SUCCESS |

---

## üêõ Known Issues

None at this time.

---

## üí° Lessons Learned

1. **PowerShell array unwrapping** is a silent, confusing behavior
2. **Empty arrays need special handling** in function returns
3. **Debug logging is essential** for finding these issues
4. **Type checking alone isn't enough** - need proper return syntax

---

**Released:** November 13, 2025  
**Type:** Critical Bug Fix  
**Upgrade Priority:** HIGH (if on v2.2.0)  
**Breaking Changes:** None

---

## Quick Links

- [Download v2.2.1 Script](Zurg-Broken-Torrent-Monitor.ps1)
- [Full Changelog](CHANGELOG.md)
- [GitHub Release](https://github.com/maddguru/zurg-broken-torrent-monitor/releases/tag/v2.2.1)
